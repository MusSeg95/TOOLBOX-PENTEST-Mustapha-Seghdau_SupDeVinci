import tkinter as tk
from tkinter import ttk
from tkinter import filedialog
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
import subprocess

def open_main_window():
    welcome_window.destroy()
    main_window()

def main_window():
    # Define scanning functions
    def scan(ip, scan_type):
        start_loading()
        try:
            if scan_type == "Simple":
                result = subprocess.run(['nmap', ip], capture_output=True, text=True).stdout
            elif scan_type == "OS":
                result = subprocess.run(['nmap', '-O', ip], capture_output=True, text=True).stdout
            elif scan_type == "Version":
                result = subprocess.run(['nmap', '-sV', ip], capture_output=True, text=True).stdout
            elif scan_type == "TCP":
                result = subprocess.run(['nmap', '-sT', ip], capture_output=True, text=True).stdout
            elif scan_type == "Scan + Vulnérabilité":
                result = subprocess.run(['nmap', '--script', 'vuln', ip], capture_output=True, text=True).stdout
            else:
                result = "Invalid scan type"
        except Exception as e:
            result = f"Error: {str(e)}"
        stop_loading()
        return result

    # Generate PDF report
    def generate_pdf(result):
        filename = filedialog.asksaveasfilename(defaultextension=".pdf", filetypes=[("PDF files", "*.pdf")])
        if filename:
            c = canvas.Canvas(filename, pagesize=letter)
            c.drawString(100, 750, "Nmap Report")
            c.drawString(100, 730, "-" * 50)
            c.drawString(100, 700, "Scan Result:")
            y = 680
            for line in result.split("\n"):
                c.drawString(100, y, line)
                y -= 15
            c.save()

    # Action function for scan button
    def action_scan():
        ip_address = ip_entry.get()
        selected_scan = scan_type_var.get()
        result = scan(ip_address, selected_scan)
        result_text.set(result)

    def print_report():
        generate_pdf(result_text.get())

    def reset_window():
        ip_entry.delete(0, tk.END)
        result_text.set("")
        scan_type_var.set("")

    def start_loading():
        loading_label.config(text="Loading...")
        loading_progress.start()

    def stop_loading():
        loading_label.config(text="")
        loading_progress.stop()

    # Set up the main GUI window
    root = tk.Tk()
    root.title("Nmap Scanner")
    root.configure(bg='black')

    frame = tk.Frame(root, bg='black')
    frame.pack(padx=20, pady=20)

    # Variables for storing scan result and scan type
    result_text = tk.StringVar()
    scan_type_var = tk.StringVar()

    # GUI components
    ip_label = tk.Label(frame, text="Enter IP Address:", bg='black', fg='white')
    ip_label.grid(row=0, column=0, padx=(0, 20), pady=(0, 10))

    ip_entry = tk.Entry(frame)
    ip_entry.grid(row=0, column=1, padx=(0, 20), pady=(0, 10))

    scan_type_label = tk.Label(frame, text="Select Scan Type:", bg='black', fg='white')
    scan_type_label.grid(row=1, column=0, padx=(0, 20), pady=(0, 10))

    scan_type_options = ["Simple", "OS", "Version", "TCP", "Scan + Vulnérabilité"]
    scan_type_menu = tk.OptionMenu(frame, scan_type_var, *scan_type_options)
    scan_type_menu.grid(row=1, column=1, padx=(0, 20), pady=(0, 10))

    scan_button = tk.Button(frame, text="Scan", command=action_scan, width=15, height=2)
    scan_button.grid(row=2, column=0, columnspan=2, padx=(0, 20), pady=(0, 10))

    result_label = tk.Label(frame, textvariable=result_text, fg="blue", justify="left", anchor="w", wraplength=400, bg='black')
    result_label.grid(row=3, column=0, padx=(0, 20), pady=(0, 10), columnspan=2, sticky="w")

    reset_button = tk.Button(frame, text="Reset", command=reset_window, width=15, height=2)
    reset_button.grid(row=4, column=0, padx=(0, 20), pady=(0, 10))

    print_button = tk.Button(frame, text="Print Report", command=print_report, width=15, height=2)
    print_button.grid(row=4, column=1, padx=(0, 20), pady=(0, 10))

    # Loading bar and label
    loading_progress = ttk.Progressbar(frame, mode='indeterminate')
    loading_label = tk.Label(frame, text="", bg='black', fg='white')
    loading_label.grid(row=5, column=0, columnspan=2, pady=(10, 0))

    root.mainloop()

welcome_window = tk.Tk()
welcome_window.title("Welcome")
welcome_window.geometry("300x200")
welcome_window.configure(bg='black')

welcome_label = tk.Label(welcome_window, text="Welcome to Nmap Scanner", font=("Helvetica", 16), bg='black', fg='white')
welcome_label.pack(pady=20)

open_button = tk.Button(welcome_window, text="Open Scanner", command=open_main_window, width=15, height=2)
open_button.pack(pady=10)

welcome_window.mainloop()
